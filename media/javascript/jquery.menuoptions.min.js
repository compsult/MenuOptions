$.widget("mre.menuoptions",{options:{ClearBtn:true,SelectOnly:false,Data:"",ColumnCount:1,UseValueForKey:false,PlaceHolder:"",Width:"",ShowAt:"bottom",Sort:["alpha","asc"],Filters:[],MenuOptionsType:"Select",DisableHiLiting:false,_ID:"UnIqDrOpDoWnSeLeCt",_prev_event:"",_prev_target:"",_prevXY:{X:0,Y:0},_CurrentFilter:"",_orig_bg:"",_event_ns:"",_menu_box:{top:0,bottom:0,left:0,right:0,overlap:3},_width_adj:{width_menu:0,width_adjustment:0,width_after_adj:0},},_create:function(){var a="";if(this.options.Data.toString()===""){this._validation_fail("MenuOptions requires the Data parameter to be populated");return}if(this.options.ColumnCount<1){this._validation_fail("MenuOptions requires ColumnCount parameter be > 0");return}this._set_options();this._add_clear_btn();this.orig_objs=this.ary_of_objs=this._build_array_of_objs();if(this.orig_objs===false){this._validation_fail("Invalid Data format supplied to menuoptions");return}this._buildDropDown(this.orig_objs);this._bindUIActions();this._detect_destroyed_input();this._refresh();$(this.element).addClass("ui-menuoptions");$(this.element).attr("autocomplete","off")},_validation_fail:function(a){alert(a);this._destroy()},refreshData:function(a){var b=this;$(this.element).val("");$.each(a,function(c,d){if(b.options.hasOwnProperty(c)){b._setOption(c,a[c])}});this._set_options();this.orig_objs=this.ary_of_objs=this._build_array_of_objs();this._buildDropDown(this.orig_objs)},add_menuoption_key:function(){var a=this.element.val();matchedRec=$.grep(this.ary_of_objs,function(b){return b.val===a});if(matchedRec.length>0){$(this.element).attr("menu_opt_key",matchedRec[0].ky)}},_detect_destroyed_input:function(){$(this.element).bind("remove",function(a){this._destroy()})},_buildWholeDropDown:function(a){if(a.type==="search"){$(this.element).attr("menu_opt_key","")}if(a.type==="click"&&this.options._prev_event==="mouseenter"){return}this.options._prev_event=a.type;this.ary_of_objs=this.orig_objs;if(this.cached[".txtbox"].val().length){this._processMatches(a,this.cached[".txtbox"].val(),true);return}this._buildDropDown(this.orig_objs);this._showDropDown(a)},_buildFilteredDropDown:function(a){this._buildDropDown(this.ary_of_objs);this._showDropDown(a)},_buildDropDown:function(a){this._event_ns=this.eventNamespace.replace(/^\./,"");tablehtml=this._createHtmlTable(a);this.dropdownbox=$(tablehtml);this._cacheElements();this._calcDropBoxCoordinates()},_colorInputBorder:function(b,a){var d="";if(this.options.DisableHiLiting){return}var c=false;if(a){c=$.grep(this.ary_of_objs,function(e){d=e.val.replace(/^ *<.*?>/,"");return b.match(new RegExp(d,"i"))});if(c.length===0){$(this.element).css({"border-color":"red"})}else{$(this.element).css({"border-color":this.options._orig_bg})}}},__triggerChoice:function(b){var a=$("table.CrEaTeDtAbLeStYlE").find("td:first");this.element.val(a.text());this.element.attr("menu_opt_key",a.attr("menu_opt_key"));$(this.element).css({"border-color":this.options._orig_bg});this._trigger("onSelect",this,{newCode:$(b.target).attr("menu_opt_key"),newVal:a.text(),type:"EnterKey"});this.cached[".dropdownspan"].remove()},__buildMatchAry:function(e,c,a){var f=[],b=this.orig_objs,d=true;for(i=0;i<b.length;i++){no_img_val=b[i].val.replace(/<img.*>/,"");if(no_img_val.toLowerCase()==c.toLowerCase()){while(f.length>0){f.pop()}f.push(a?no_img_val:b[i]);d=false;break}else{if(no_img_val.match(new RegExp(c,"i"))){f.push(a?no_img_val:b[i]);d=false}}}if(d==true){this.cached[".txtbox"].val(this.cached[".txtbox"].val().slice(0,-1))}return f},_processMatches:function(d,c,a){var e=[],b="";if(c!==""){e=this.__buildMatchAry(d,c,false);this.cached[".dropdownspan"].remove()}if(e.length>0){this.ary_of_objs=e;this._buildFilteredDropDown(d)}else{this._buildWholeDropDown(d)}this._colorInputBorder(c,a)},_runHeaderFilters:function(b){if(this.cached[".txtbox"].val().length){return}if(this.options._CurrentFilter===$(b.currentTarget).text()){return}var a=$(b.currentTarget).text();this.options._CurrentFilter=$(b.currentTarget).text();if($.isPlainObject(this.options.Filters[0])){if($(b.currentTarget).attr("menuopt_regex")){a=$(b.currentTarget).attr("menuopt_regex");this._processMatches(b,a,false)}else{if($(b.currentTarget).text().match(/all/i)){this._buildWholeDropDown(b)}else{alert("Filter key "+$(b.currentTarget).text()+"does not have a matching regular expression")}}}else{if($.inArray(a,this.options.Filters)>-1){this._processMatches(b,a,false)}else{this._buildWholeDropDown(b)}}},_createFilterHeader:function(){var b=[],a="";if(!$.isPlainObject(this.options.Filters[0])){b=$.map(this.options.Filters,function(d,c){return"\t<td class=dflt>"+d+"</td>\n"});b.unshift("\t<td class=dflt>(all)</td>\n")}else{$.each(this.options.Filters,function(c,d){for(var e in d){a=e}b.push('\t<td class=dflt menuopt_regex="'+d[e]+'">'+a+"</td>\n")});b.unshift("\t<td class=dflt>(all)</td>\n")}return"\n<table id=HF_"+this._event_ns+" class=HdrFilter>\n<tr>\n"+b.join("")+"</tr>\n</table>\n"},_clearHx:function(a){this.options._CurrentFilter=""},_bindUIActions:function(){var b="",a={};b="mouseenter span#SP_"+this.options._ID+" table#HF_"+this._event_ns+" td.dflt";a[b]="_runHeaderFilters";b="click span#SP_"+this.options._ID+" table#HF_"+this._event_ns+" td.dflt";a[b]="_runHeaderFilters";b="mouseleave  span#SP_"+this.options._ID+" table#HF_"+this._event_ns+" td.dflt";a[b]="_clearHx";this._on($("body"),a);this._on(this.cached[".clearBtn"],{mouseleave:"_hiLiteOnOff",mouseenter:"_hiLiteOnOff",click:function(c){$(this.element).val("");$(this.element).attr("menu_opt_key","");this._buildWholeDropDown(c)}});this._on({click:"_buildWholeDropDown",mouseenter:"_buildWholeDropDown",focus:"_buildWholeDropDown",search:"_buildWholeDropDown",mouseleave:"_removeDropDown",blur:"_removeDropDown"});this._on($("body"),{"mouseleave span table.CrEaTeDtAbLeStYlE td.dflt":"_hiLiteOnOff","mouseenter span table.CrEaTeDtAbLeStYlE td.dflt":"_hiLiteOnOff"});b="mousedown span#SP_"+this.options._ID+" table.CrEaTeDtAbLeStYlE td ";a[b]="_choiceSelected";this._on($("body"),a);b="mouseleave span#SP_"+this.options._ID;a[b]="_removeDropDown";this._on($("body"),a);this._on(this.cached[".txtbox"],{keypress:"_autocomplete",keyup:"_autocomplete",keydown:"_autocomplete"})},_autocomplete:function(a){if($(this.options)[0].MenuOptionsType.match(/Navigate/i)){return}if(a.type.match(/keyup|keydown/)){if(a.originalEvent===$.ui.keyCode.ENTER||a.originalEvent.keyCode===$.ui.keyCode.ENTER){a.preventDefault();this._processMatches(a,this.cached[".txtbox"].val(),true);this.__triggerChoice(a);return}if((a.originalEvent===$.ui.keyCode.TAB||a.originalEvent.keyCode===$.ui.keyCode.TAB)&&this.cached[".txtbox"].val()!=""){this._processMatches(a,this.cached[".txtbox"].val(),true);this.__triggerChoice(a);return}}if((a.type=="keydown")&&this.cached[".txtbox"].val()!=""&&(a.originalEvent===$.ui.keyCode.TAB||a.originalEvent.keyCode===$.ui.keyCode.TAB)){var b=this.__buildMatchAry(a,this.cached[".txtbox"].val(),true);if(b.length>0){this.__triggerChoice(a)}return}if(a.type=="keypress"&&this.cached[".txtbox"].val()!=""){var b=this.__buildMatchAry(a,this.cached[".txtbox"].val(),true);if(b[0]==this.cached[".txtbox"].val()){return}}this._processMatches(a,this.cached[".txtbox"].val(),true)},_hiLiteOnOff:function(a){if($(a.target).attr("class").match(/clear_btn/)){$(a.target).toggleClass("ClearButtonMO")}if($(a.target).attr("class").match(/ *dflt */)){if(a.type==="mouseenter"){$(a.target).addClass("mo")}else{$(a.target).removeClass("mo")}}},_refresh:function(){},_cacheElements:function(){var d=this.dropdownbox,c=this.dropdownbox.find("td"),b=this.element,a=$("div#CB_"+this._event_ns);this.cached={".dropdownspan":d,".dropdowncells":c,".clearBtn":a,".txtbox":b}},_setOptions:function(){this._superApply(arguments);this._refresh()},_setOption:function(a,b){this._super(a,b)},_set_options:function(){if(this.options.ShowAt.match(/^ *bottom *$/i)){this.options._menu_box.overlap=3;this._setOption("ShowAt","left bottom")}else{if(this.options.ShowAt.match(/^ *right *$/i)){this.options._menu_box.overlap=-3;this._setOption("ShowAt","right top")}}if(this.options.SelectOnly){$(this.element).prop("readonly",true)}if(this.options.PlaceHolder!==""){$(this.element).prop("placeholder",this.options.PlaceHolder)}this._setOption("Data",this.options.Data);this._setOption("_ID",this.eventNamespace.replace(/^\./,""));this._setOption("_orig_bg",$(this.element).css("background-color"))},re_serialize:function(b){var a="";$.each(b.split("&"),function(d,c){$.each(c.split("="),function(f,e){if($('input[name="'+e+'"]')&&$('input[name="'+e+'"]').attr("menu_opt_key")){a+=e+"="+$('input[name="'+e+'"]').attr("menu_opt_key")+"&"}else{a+=e+"="+$('input[name="'+e+'"]').val()+"&"}return false})});return a.slice(0,-1)},_destroy:function(){$(this.element).removeClass("ui-menuoptions");$("span#SP_"+this.options._ID).remove();this._super()},_runSort:function(a){if(this.options.Sort.length>0){sortInstruct=this.options.Sort;if(sortInstruct[0].match(/alpha/i)&&sortInstruct[1].match(/asc/i)){a.sort(function(d,c){return((d.val)>(c.val)?1:((c.val)>(d.val))?-1:0)})}if(sortInstruct[0].match(/alpha/i)&&sortInstruct[1].match(/desc/i)){a.sort(function(d,c){return((d.val)<(c.val)?1:((c.val)<(d.val))?-1:0)})}if(sortInstruct[0].match(/num/i)&&sortInstruct[1].match(/asc/i)){a.sort(function(d,c){return(d-c)})}if(sortInstruct[0].match(/num/i)&&sortInstruct[1].match(/desc/i)){a.sort(function(d,c){return(c-d)})}}},_createHtmlTable:function(a){var b="",d=[],g=0,f=0,c="",e=this;this._runSort(a);if(this.options.UseValueForKey===true){$.each(a,function(j,h){h.val=h.ky})}while(g*this.options.ColumnCount<a.length){f=g===0?0:(g*this.options.ColumnCount);subary=a.slice(f,f+this.options.ColumnCount);d=$.map(subary,function(j,h){if(!$.isFunction(j.ky)&&j.ky.match(/divider/i)&&e.options.MenuOptionsType==="Navigate"){return"\t<td class="+j.ky+">"+j.val+"</td>\n"}else{return'\t<td class=dflt menu_opt_key="'+j.ky+'">'+j.val+"</td>\n"}});for(i=subary.length+1;i<=this.options.ColumnCount;i+=1){d.push('<td class=dflt menu_opt_key="">&nbsp;</td>')}b+="<tr>\n"+d.join("")+"</tr>\n";g+=1}b="<table class=CrEaTeDtAbLeStYlE cellpadding=4px>\n"+b+"</table>";if(this.options.Filters.length){b=this._createFilterHeader()+b}c="<span id=SP_"+this.options._ID+">"+b+"\n</span>";return c},_add_clear_btn:function(){if(this.options.ClearBtn&&this.options.MenuOptionsType==="Select"){ClrBtn="<div class=clear_btn id=CB_"+this.eventNamespace.replace(/^\./,"")+"></div>";$(this.element).after(ClrBtn)}},_obj_create:function(a,b){if($.isArray(b)==true){a.push({ky:b[0],val:b[1]})}else{for(var c in b){if(b.hasOwnProperty(c)){a.push({ky:c,val:b[c]})}else{alert("Data error: Key with no value error in incoming Data parameter");return false}}}return true},_build_array_of_objs:function(){var b=this,a=[];if(typeof b.options.Data[0]==="string"){a=$.map(b.options.Data,function(d,c){return{ky:d,val:d}})}else{$.each(b.options.Data,function(c,d){if(!$.isArray(b.options.Data)){a.push({ky:c,val:d})}else{if($.isPlainObject(b.options.Data[0])){if(b._obj_create(a,d)===false){return false}}else{if($.isArray(b.options.Data[0])){b._obj_create(a,d)}}}b.total_rec_cnt+=1})}if(b.options.MenuOptionsType==="Navigate"){a=$.map(a,function(d,c){return{ky:d.val,val:d.ky}})}return a},_runMenuItem:function(b){var a=$(b.target).text().replace(/^<.*>/,"");var c=$.grep(this.ary_of_objs,function(d){return a===d.val.replace(/^< *img.*?>/,"")});if(c&&c.length>0){if($.isFunction(c[0].ky)){c[0].ky.call()}else{if(!$(b.target).attr("class").match(/divider/i)){window.open(c[0].ky)}}}},_choiceSelected:function(c){if($(c.currentTarget).text()===this._prev_target&&c.pageX===this.options._prevXY.X&&c.pageY===this.options._prevXY.Y){return}this._prev_target=$(c.currentTarget).text();this.options._prevXY.X=c.pageX;this.options._prevXY.Y=c.pageY;this.options._prev_event=c.type;var b=this;if(b.options.MenuOptionsType==="Select"){var a=$.trim($(c.target).text());b.element.val(a);b._trigger("onSelect",b,{newCode:$(c.target).attr("menu_opt_key"),newVal:a,type:"Click"});b.element.attr("menu_opt_key",$(c.target).attr("menu_opt_key"));c.target.className=c.target.className.replace(/ mo/,"")}else{this._runMenuItem(c)}$(this.cached[".dropdowncells"]).removeClass("mo");b.cached[".dropdownspan"].remove();$(this.element).css({"border-color":this.options._orig_bg})},_calcDropBoxCoordinates:function(){this.options._menu_box.top=this.cached[".dropdownspan"].position().top-this.options._menu_box.overlap;this.options._menu_box.bottom=this.options._menu_box.top+this.cached[".dropdownspan"].height()+this.options._menu_box.overlap;this.options._menu_box.left=this.cached[".dropdownspan"].position().left-3;this.options._menu_box.right=this.options._menu_box.left+this.cached[".dropdownspan"].width()},_didMouseExitDropDown:function(a){if(a.pageX>this.options._menu_box.left&&a.pageX<this.options._menu_box.right&&a.pageY>this.options._menu_box.top&&a.pageY<this.options._menu_box.bottom){return false}else{return true}},_removeDropDown:function(a){if(a.type==="blur"&&this.options._prev_event==="mouseleave"){return}this.options._prev_event=a.type;if($("span#SP_"+this.options._ID).length){if(this._didMouseExitDropDown(a)===true){this.cached[".dropdownspan"].remove()}}},_resetOffsetOfDropDown:function(){if($dd_span.menu_start_loc.left!==$dd_span.cached[".dropdownspan"].offset().left||$dd_span.menu_start_loc.top!==$dd_span.cached[".dropdownspan"].offset().top){if($dd_span.cached[".dropdownspan"]&&$dd_span.cached[".dropdownspan"][0]){$dd_span.options._width_adj.width_adjustment=parseInt($dd_span.cached[".dropdownspan"][0].style.left)+(($dd_span.options._width_adj.width_after_adj-$dd_span.options._width_adj.width_menu)/2);$dd_span.cached[".dropdownspan"].css({left:$dd_span.options._width_adj.width_adjustment})}}},_addDropDownToDOM:function(){var a=this;$('body span[id^="SP_menuoption"]').remove();this.dropdownbox.appendTo("body").hide(1).position({of:this.element,my:"left top",at:a.options.ShowAt,collision:"flipfit"})},_showDropDown:function(a){var b=this;this._addDropDownToDOM();$("span#SP_"+b.options._ID).css({zIndex:9999});this._getAndSetDropDownWidth();b.cached[".dropdownspan"].stop(true,false).show();$("table.CrEaTeDtAbLeStYlE").find("tr:even").addClass("even");$("table.CrEaTeDtAbLeStYlE").find("tr:odd").addClass("odd");this._refresh();this._calcDropBoxCoordinates()},_getAndSetDropDownWidth:function(){var b=this,a=parseInt($("span#SP_"+b.options._ID).css("width"),10);b.menu_start_loc=b.cached[".dropdownspan"].offset();b.options._width_adj.width_menu=a;b.options._width_adj.width_after_adj=(a>$(this.element).width())?a:$(this.element).outerWidth();if(b.options.Width!==""){b.options._width_adj.width_after_adj=(parseInt(b.options.Width))}$("span#SP_"+b.options._ID+", span#SP_"+b.options._ID+" > table").css({width:b.options._width_adj.width_after_adj});if(this.options.ShowAt.match(/left bottom/i)){$("span#SP_"+b.options._ID).offset({left:$(this.element).offset().left})}else{$("span#SP_"+b.options._ID).offset({left:$(this.element).offset().left+$(this.element).outerWidth()})}},});